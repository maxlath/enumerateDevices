<!DOCTYPE html>
<html>
    <head>
        <title>Enumerate Devices Demo</title>
    </head>
    <body>
        <style>
            .hide {
                display: none;
            }
            .error-message {
                color: red;
            }
        </style>
        <div id="http-message">
            <p>To avoid repeated permissions prompts, run on https</p>
            <p>Devices will have generic labels (e.g., "camera 1") on http. For real device names, run on https.</p>
        </div>
        <div id="device-selection">
            <select id="video-options"></select>
            <select id="audio-options"></select>
            <button type="button" id="refresh-video">Get Video From Devices</button>
        </div>
        <div id="video-display">
            <video id="video-preview"></video>
        </div>
        <div class="error-message hide">
            <p>Sorry, your browser doesn't support device enumeration</p>
        </div>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="../enumerateDevices.bundle.js"></script>
        <script src="../node_modules/attachmediastream/getusermedia.bundle.js"></script>
        <script src="../node_modules/attachmediastream/attachmediastream.bundle.js"></script>
        <script>
            var mediaStreamInUse;

            function setError(err, $featureContainer) {
                $featureContainer && $featureContainer.toggleClass('hide', !!err);
                $('.error-message').toggleClass('hide', !err).text(err && err.message);
                return !!err;
            }

            function buildConstraints(audioDeviceId, videoDeviceId) {
                var mediaConstraints = {};
                if (audioDeviceId) {
                    mediaConstraints.audio = {
                        optional: [ { sourceId: audioDeviceId} ]
                    };
                } else {
                    mediaConstraints.audio = true;
                }
                if (videoDeviceId) {
                    mediaConstraints.video = {
                        optional: [ { deviceId: videoDeviceId } ]
                    };
                } else {
                    mediaConstraints.video = true;
                }
                return mediaConstraints;
            }

            function getVideoWithDevices(audioDeviceId, videoDeviceId) {
                var constraints = buildConstraints(audioDeviceId, videoDeviceId);
                if (mediaStreamInUse) {
                    mediaStreamInUse.stop();
                }
                getUserMedia(constraints, function(err, stream) {
                    if (setError(err, $('#video-display'))) return;
                    var options = {
                        mirror: true,
                        muted: false,
                        audio: false,
                        autoPlay: true
                    };
                    mediaStreamInUse = stream;
                    attachMediaStream(stream, $('#video-preview')[0], options);
                    updateDeviceOptions();
                });
            }
            function updateDeviceOptions () {
                enumerateDevices(function(err, devices) {
                    if (setError(err, $('#video-display, #device-selection'))) return;

                    var selectedAudio = $('#audio-options').val();
                    var selectedVideo = $('#video-options').val();

                    $('#audio-options').find('option').remove();
                    $('#video-options').find('option').remove();

                    var audioDevicesCount = 0;
                    var videoDevicesCount = 0;
                    for (var i = 0; i < devices.length; i++) {
                        var device = devices[i];
                        if (device.kind === 'audioinput') {
                            audioDevicesCount++;
                            var label = device.label || 'Microphone ' + audioDevicesCount;
                            $('#audio-options').append($('<option/>').val(device.deviceId).text(label));
                        } else if (device.kind === 'videoinput') {
                            videoDevicesCount++;
                            var label = device.label || 'Camera ' + videoDevicesCount;
                            $('#video-options').append($('<option/>').val(device.deviceId).text(label));
                        }
                    }
                    if (selectedAudio && $('#audio-options').find('option[value="' + selectedAudio +'"]')) {
                        $('#audio-options').val(selectedAudio);
                    } else {
                        $('#audio-options')[0].selectedIndex = 0;
                    }

                    if (selectedVideo && $('#video-options').find('option[value="' + selectedAudio +'"]')) {
                        $('#video-options').val(selectedVideo);
                    } else {
                        $('#video-options')[0].selectedIndex = 0;
                    }
                });
            }

            $(function() {
                updateDeviceOptions();
                $('#refresh-video').click(function() {
                    var audioDeviceId = $('#audio-options').val();
                    var videoDeviceId = $('#video-options').val();
                    getVideoWithDevices(audioDeviceId, videoDeviceId);
                });

                if (window.location.protocol.indexOf('https') > -1) {
                    $('#http-message').hide();
                }
            });
        </script>
    </body>
</html>
